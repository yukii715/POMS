package com.owsb.poms.ui.admin.Users;

import com.owsb.poms.system.functions.*;
import com.owsb.poms.system.model.User.*;
import com.owsb.poms.ui.common.*;
import java.awt.Dimension;
import java.time.LocalDate;
import javax.swing.*;


public class UserCreation extends javax.swing.JDialog {
    private User.Role role;
    private String username;
    
    public UserCreation() {
    }
    
    public UserCreation(java.awt.Frame parent, boolean modal, Admin admin) {
        super(parent, modal);
        initComponents();
        
        setTitle("Create a New User");
        
        for (User.Role role : User.Role.values()){
            if (role == User.Role.Root) continue;
            if (role == User.Role.Admin){
                if (admin.getRole() != User.Role.Root)continue;
            }
            cmbRole.addItem(role.name());
        }
        
        cmbRole.setSelectedIndex(-1);
        lblUID.setText("");
        lblEmail.setText("");
        
        CommonEvent.bindTextToLabel(txtUsername, lblEmail, text -> String.format("%s-%s@owsb.com.my", text.toUpperCase().replace(" ", ""), lblUID.getText()));
    }

    /**
     * This method is called from within the constructor to initialize the form.
     * WARNING: Do NOT modify this code. The content of this method is always
     * regenerated by the Form Editor.
     */
    @SuppressWarnings("unchecked")
    // <editor-fold defaultstate="collapsed" desc="Generated Code">//GEN-BEGIN:initComponents
    private void initComponents() {

        pnlMain = new javax.swing.JPanel();
        jLabel6 = new javax.swing.JLabel();
        jLabel2 = new javax.swing.JLabel();
        cmbRole = new javax.swing.JComboBox<>();
        jLabel3 = new javax.swing.JLabel();
        txtUsername = new javax.swing.JTextField();
        btnCreate = new javax.swing.JButton();
        jLabel4 = new javax.swing.JLabel();
        jLabel5 = new javax.swing.JLabel();
        txtBirthday = new javax.swing.JTextField();
        lblEmail = new javax.swing.JLabel();
        jLabel7 = new javax.swing.JLabel();
        lblUID = new javax.swing.JLabel();

        setDefaultCloseOperation(javax.swing.WindowConstants.DISPOSE_ON_CLOSE);

        pnlMain.setBackground(new java.awt.Color(255, 204, 204));

        jLabel6.setFont(new java.awt.Font("Berlin Sans FB", 0, 24)); // NOI18N
        jLabel6.setForeground(new java.awt.Color(0, 0, 0));
        jLabel6.setHorizontalAlignment(javax.swing.SwingConstants.LEFT);
        jLabel6.setText("New User");

        jLabel2.setFont(new java.awt.Font("Berlin Sans FB", 0, 14)); // NOI18N
        jLabel2.setForeground(new java.awt.Color(0, 0, 0));
        jLabel2.setHorizontalAlignment(javax.swing.SwingConstants.LEFT);
        jLabel2.setText("Role:");

        cmbRole.setSelectedItem(null);
        cmbRole.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                cmbRoleActionPerformed(evt);
            }
        });

        jLabel3.setFont(new java.awt.Font("Berlin Sans FB", 0, 14)); // NOI18N
        jLabel3.setForeground(new java.awt.Color(0, 0, 0));
        jLabel3.setHorizontalAlignment(javax.swing.SwingConstants.LEFT);
        jLabel3.setText("User Name:");

        txtUsername.setFont(new java.awt.Font("Berlin Sans FB", 0, 14)); // NOI18N

        btnCreate.setBackground(new java.awt.Color(255, 153, 0));
        btnCreate.setFont(new java.awt.Font("Berlin Sans FB", 0, 14)); // NOI18N
        btnCreate.setForeground(new java.awt.Color(252, 251, 249));
        btnCreate.setText("Create");
        btnCreate.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                btnCreateActionPerformed(evt);
            }
        });

        jLabel4.setFont(new java.awt.Font("Berlin Sans FB", 0, 14)); // NOI18N
        jLabel4.setForeground(new java.awt.Color(0, 0, 0));
        jLabel4.setHorizontalAlignment(javax.swing.SwingConstants.LEFT);
        jLabel4.setText("Email:");
        jLabel4.setToolTipText("");

        jLabel5.setFont(new java.awt.Font("Berlin Sans FB", 0, 14)); // NOI18N
        jLabel5.setForeground(new java.awt.Color(0, 0, 0));
        jLabel5.setHorizontalAlignment(javax.swing.SwingConstants.LEFT);
        jLabel5.setText("Birthday:");
        jLabel5.setToolTipText("");

        txtBirthday.setFont(new java.awt.Font("Berlin Sans FB", 0, 14)); // NOI18N

        lblEmail.setFont(new java.awt.Font("Berlin Sans FB", 0, 14)); // NOI18N
        lblEmail.setForeground(new java.awt.Color(0, 0, 0));
        lblEmail.setHorizontalAlignment(javax.swing.SwingConstants.LEFT);
        lblEmail.setText("[Email]");
        lblEmail.setToolTipText("");

        jLabel7.setFont(new java.awt.Font("Berlin Sans FB", 0, 14)); // NOI18N
        jLabel7.setForeground(new java.awt.Color(0, 0, 0));
        jLabel7.setHorizontalAlignment(javax.swing.SwingConstants.LEFT);
        jLabel7.setText("ID:");
        jLabel7.setToolTipText("");

        lblUID.setFont(new java.awt.Font("Berlin Sans FB", 0, 14)); // NOI18N
        lblUID.setForeground(new java.awt.Color(0, 0, 0));
        lblUID.setHorizontalAlignment(javax.swing.SwingConstants.LEFT);
        lblUID.setText("[UID]");
        lblUID.setToolTipText("");

        javax.swing.GroupLayout pnlMainLayout = new javax.swing.GroupLayout(pnlMain);
        pnlMain.setLayout(pnlMainLayout);
        pnlMainLayout.setHorizontalGroup(
            pnlMainLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(pnlMainLayout.createSequentialGroup()
                .addContainerGap(25, Short.MAX_VALUE)
                .addGroup(pnlMainLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addComponent(jLabel2)
                    .addComponent(jLabel7)
                    .addComponent(jLabel3)
                    .addComponent(jLabel4)
                    .addComponent(jLabel5))
                .addGap(36, 36, 36)
                .addGroup(pnlMainLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addComponent(txtUsername, javax.swing.GroupLayout.PREFERRED_SIZE, 193, javax.swing.GroupLayout.PREFERRED_SIZE)
                    .addComponent(lblUID)
                    .addComponent(cmbRole, javax.swing.GroupLayout.PREFERRED_SIZE, 193, javax.swing.GroupLayout.PREFERRED_SIZE)
                    .addComponent(lblEmail)
                    .addComponent(txtBirthday, javax.swing.GroupLayout.PREFERRED_SIZE, 193, javax.swing.GroupLayout.PREFERRED_SIZE))
                .addContainerGap(javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE))
            .addGroup(pnlMainLayout.createSequentialGroup()
                .addGap(0, 0, Short.MAX_VALUE)
                .addGroup(pnlMainLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addComponent(jLabel6)
                    .addComponent(btnCreate, javax.swing.GroupLayout.PREFERRED_SIZE, 101, javax.swing.GroupLayout.PREFERRED_SIZE))
                .addContainerGap(javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE))
        );
        pnlMainLayout.setVerticalGroup(
            pnlMainLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(pnlMainLayout.createSequentialGroup()
                .addContainerGap()
                .addComponent(jLabel6)
                .addGap(23, 23, 23)
                .addGroup(pnlMainLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                    .addComponent(jLabel2)
                    .addComponent(cmbRole, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE))
                .addGap(18, 18, 18)
                .addGroup(pnlMainLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                    .addComponent(jLabel7)
                    .addComponent(lblUID))
                .addGap(18, 18, 18)
                .addGroup(pnlMainLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                    .addComponent(txtUsername, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                    .addComponent(jLabel3))
                .addGap(18, 18, 18)
                .addGroup(pnlMainLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                    .addComponent(lblEmail)
                    .addComponent(jLabel4))
                .addGap(18, 18, 18)
                .addGroup(pnlMainLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                    .addComponent(jLabel5)
                    .addComponent(txtBirthday, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE))
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED, 32, Short.MAX_VALUE)
                .addComponent(btnCreate, javax.swing.GroupLayout.PREFERRED_SIZE, 39, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addGap(18, 18, 18))
        );

        javax.swing.GroupLayout layout = new javax.swing.GroupLayout(getContentPane());
        getContentPane().setLayout(layout);
        layout.setHorizontalGroup(
            layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addComponent(pnlMain, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
        );
        layout.setVerticalGroup(
            layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addComponent(pnlMain, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
        );

        pack();
    }// </editor-fold>//GEN-END:initComponents

    private void cmbRoleActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_cmbRoleActionPerformed
        if (cmbRole.getSelectedIndex() >= 0){
            role = User.Role.valueOf(cmbRole.getSelectedItem().toString());
            username = txtUsername.getText().toUpperCase().replace(" ", "").trim();
            
            switch (role) {
                case Admin:
                    lblUID.setText(new Admin().generateID());
                    lblEmail.setText(String.format("%s-%s@owsb.com.my", username, lblUID.getText()));
                    break;
                case SalesManager:
                    lblUID.setText(new SalesManager().generateID());
                    lblEmail.setText(String.format("%s-%s@owsb.com.my", username, lblUID.getText()));
                    break;
                case PurchaseManager:
                    lblUID.setText(new PurchaseManager().generateID());
                    lblEmail.setText(String.format("%s-%s@owsb.com.my", username, lblUID.getText()));
                    break;
                case InventoryManager:
                    lblUID.setText(new InventoryManager().generateID());
                    lblEmail.setText(String.format("%s-%s@owsb.com.my", username, lblUID.getText()));
                    break;
                case FinanceManager:
                    lblUID.setText(new FinanceManager().generateID());
                    lblEmail.setText(String.format("%s-%s@owsb.com.my", username, lblUID.getText()));
                    break;
            }
        }
    }//GEN-LAST:event_cmbRoleActionPerformed

    private void btnCreateActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_btnCreateActionPerformed
        String uid = lblUID.getText();
        String email = lblEmail.getText();
        String password = SecurePassword.newPassword();
        String birthday = txtBirthday.getText().trim();
        username = txtUsername.getText().toUpperCase().trim();
        
        if (cmbRole.getSelectedIndex() == -1){
            JOptionPane.showMessageDialog(
                   this, 
                   "Please select a role for this account!", 
                   "Error", 
                   JOptionPane.ERROR_MESSAGE
           );
                return;
        }
        
        if (!UserValidation.validUsername(username)){
           JOptionPane.showMessageDialog(
                   this, 
                   "Invalid username, it might be:\n"
                 + "1. Username already existed\n"
                 + "2. Username contains invalid characters\n"
                 + "3. Username is blank\n"
                 + "Note: Username can only contains alphabets (At least 3)", 
                   "Error", 
                   JOptionPane.ERROR_MESSAGE
           );
                return;
        }
        
        if (!UserValidation.validBirthday(birthday)){
            JOptionPane.showMessageDialog(
                   this, 
                   "Invalid birthday\n"
                 + "Note: Please enter the birthday in yyyyMMdd form\n"
                 + "E.g. 20000101 (1 January 2000)\n"
                 + "*All employees must be 16 years of age or older", 
                   "Error", 
                   JOptionPane.ERROR_MESSAGE
           );
                return;
        }
        
        int result = JOptionPane.showConfirmDialog(this, String.format("Are you sure to create user %s", lblUID.getText()), "Create User", JOptionPane.YES_NO_OPTION, JOptionPane.QUESTION_MESSAGE);
        if (result == JOptionPane.YES_OPTION){
            
            User user = new User(uid, username, email, password, role, User.getBirthdayByString(birthday));
            user.add();
            
            String message = String.format("User %s has created successfully!%nPassword: %s", 
                lblUID.getText(), password);
            JTextArea textArea = new JTextArea(message);
            textArea.setEditable(false);
            textArea.setLineWrap(true);
            textArea.setWrapStyleWord(true);
            textArea.setBackground(UIManager.getColor("Panel.background")); 
            textArea.setBorder(null);
            textArea.setPreferredSize(new Dimension(250, 50));

            JOptionPane.showMessageDialog(this, textArea, "Account Created", JOptionPane.INFORMATION_MESSAGE);
            dispose();
        }
    }//GEN-LAST:event_btnCreateActionPerformed

    // Variables declaration - do not modify//GEN-BEGIN:variables
    private javax.swing.JButton btnCreate;
    private javax.swing.JComboBox<String> cmbRole;
    private javax.swing.JLabel jLabel2;
    private javax.swing.JLabel jLabel3;
    private javax.swing.JLabel jLabel4;
    private javax.swing.JLabel jLabel5;
    private javax.swing.JLabel jLabel6;
    private javax.swing.JLabel jLabel7;
    private javax.swing.JLabel lblEmail;
    private javax.swing.JLabel lblUID;
    private javax.swing.JPanel pnlMain;
    private javax.swing.JTextField txtBirthday;
    private javax.swing.JTextField txtUsername;
    // End of variables declaration//GEN-END:variables
}
